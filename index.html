/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// ================================= CONFIGURATION =================================
const SHEET_ID = "1PHtLUtMEYmOLzLYPGxjesMPDtTj3l4DRpsUZUGtHdqg";
const SHEET_NAME = "Transactions";
// =================================================================================

/**
 * Main entry point for all GET requests.
 */
function doGet(e) {
  const params = e.parameter;
  const action = params.action;
  const callback = params.callback;
  let result = {};

  try {
    const lock = LockService.getScriptLock();
    lock.waitLock(30000);

    try {
      switch (action) {
        case 'addData':
          result = addData(params);
          break;
        case 'getData':
          result = getData();
          break;
        case 'deleteData':
          result = deleteData(params);
          break;
        case 'updateReceivedStatus':
          result = updateReceivedStatus(params);
          break;
        default:
          throw new Error("Invalid action specified.");
      }
      result.status = 'success';
    } finally {
      lock.releaseLock();
    }
  } catch (err) {
    result.status = 'error';
    result.message = err.message;
  }

  return ContentService.createTextOutput(`${callback}(${JSON.stringify(result)})`)
    .setMimeType(ContentService.MimeType.JAVASCRIPT);
}

function getSheet() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    return ss.getSheetByName(SHEET_NAME) || ss.getSheets()[0];
  } catch (e) {
    throw new Error("Could not open the spreadsheet. Please check SHEET_ID.");
  }
}

/**
 * Adds a new row and sorts the sheet.
 */
function addData(params) {
  const sheet = getSheet();
  const newRow = [
    params.id,
    new Date(params.date),
    params.type,
    params.platform,
    params.description,
    parseFloat(params.amount),
    '' // Placeholder for ReceivedDate
  ];
  sheet.appendRow(newRow);

  if (sheet.getLastRow() > 1) {
    const range = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
    range.sort({ column: 2, ascending: true });
  }

  SpreadsheetApp.flush();
  return { message: 'Data added and sorted.' };
}

/**
 * Retrieves all data from the sheet.
 */
function getData() {
  const sheet = getSheet();
  const allData = sheet.getDataRange().getValues();

  if (allData.length < 2) {
    return { data: [] };
  }

  const headers = allData.shift().map(h => String(h).toLowerCase().trim());
  const dateColumnIndex = headers.indexOf('date');
  const receivedDateColumnIndex = headers.indexOf('receiveddate');

  const jsonData = allData.map(row => {
    let obj = {};
    headers.forEach((header, i) => {
      let value = row[i];
      if ((i === dateColumnIndex || i === receivedDateColumnIndex) && value instanceof Date) {
        value = `${value.getFullYear()}-${String(value.getMonth() + 1).padStart(2, '0')}-${String(value.getDate()).padStart(2, '0')}`;
      }
      obj[header] = (header === 'amount') ? parseFloat(value) : value;
    });
    return obj;
  });

  return { data: jsonData };
}


/**
 * Deletes a row by its unique ID.
 */
function deleteData(params) {
  const sheet = getSheet();
  const idToDelete = params.id;

  if (!idToDelete) throw new Error('No ID provided for deletion.');

  const idColumnValues = sheet.getRange(1, 1, sheet.getLastRow(), 1).getValues();
  const rowIndexToDelete = idColumnValues.findIndex(row => row[0] && row[0].toString() === idToDelete.toString());

  if (rowIndexToDelete > -1) {
    sheet.deleteRow(rowIndexToDelete + 1);
    return { message: 'Data deleted.' };
  } else {
    return { message: 'Data not found.' };
  }
}

/**
 * Updates the received date for a specific transaction ID.
 */
function updateReceivedStatus(params) {
  const sheet = getSheet();
  const idToUpdate = params.id;
  const receivedDateStr = params.receivedDate;

  if (!idToUpdate) throw new Error('No ID provided for updating.');
  
  const idColumnValues = sheet.getRange(1, 1, sheet.getLastRow(), 1).getValues();
  const rowToUpdate = idColumnValues.findIndex(row => row[0] && row[0].toString() === idToUpdate.toString()) + 1;

  if (rowToUpdate > 0) {
    // Assuming 'ReceivedDate' is the 7th column (G)
    const cell = sheet.getRange(rowToUpdate, 7);
    
    // FIX: Use clearContent() for empty dates to prevent Sheets from defaulting to FALSE.
    if (receivedDateStr && receivedDateStr.length > 0) {
      // If a date is provided, set the value.
      cell.setValue(new Date(receivedDateStr));
    } else {
      // If the date is empty (un-checked), explicitly clear the cell content.
      cell.clearContent();
    }
    
    SpreadsheetApp.flush();
    return { message: 'Status updated successfully.' };
  } else {
    throw new Error('Could not find the transaction to update.');
  }
}

